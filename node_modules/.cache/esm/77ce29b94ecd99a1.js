let Joi,bcrypt,User,RefreshToken,CustomErrorHandler,JwtServices,REFRESH_SECRET;_4ec‍.x([["default",()=>_4ec‍.o]]);_4ec‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_4ec‍.w("bcrypt",[["default",["bcrypt"],function(v){bcrypt=v}]]);_4ec‍.w("../../model",[["User",["User"],function(v){User=v}],["RefreshToken",["RefreshToken"],function(v){RefreshToken=v}]]);_4ec‍.w("../../services/CustomErrorHandler",[["default",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_4ec‍.w("../../services/JwtServices",[["default",["JwtServices"],function(v){JwtServices=v}]]);_4ec‍.w("../../config",[["REFRESH_SECRET",["REFRESH_SECRET"],function(v){REFRESH_SECRET=v}]]);






const register_controller = {
    async register(req, res, next) {

        //requested data valid or not
        const registerSchema = Joi.object({
            email: Joi.string().email({ tlds: { allow: false } }),
            password: Joi.string().pattern(new RegExp('^[a-zA-Z0-9]{3,30}$')).required(),
            c_password: Joi.ref('password'),
            first_name: Joi.string().required()
        })

        const { email, password, c_password, first_name, last_name, dob, city, social_token, login_type } = req.body

        const { error } = registerSchema.validate({ email, password, c_password, first_name })
        if (error) {
            return next(error)
        }

        try {
            if (login_type === "4") {
                const exist = await User.exists({ email: req.body.email })
                if (exist) {
                    return next(CustomErrorHandler.alreadyExist('User is already exist'));
                }
            }
        } catch (err) {
            return next(err)
        }

        //hashpassword
        const hashedpassword = await bcrypt.hash(password, 16)
        const user = new User({
            email,
            password: hashedpassword,
            first_name,
            last_name,
            dob,
            city,
            social_token,
            login_type
        })

        let access_token;
        let refresh_token;
        let data;

        try {
            data = await user.save()
            // Token
            access_token = JwtServices.sign({ _id: data._id, role: data.role });
            refresh_token = JwtServices.sign({ _id: data._id, role: data.role }, '1y', REFRESH_SECRET)
            await RefreshToken.create({ token: refresh_token })

        } catch (err) {
            return next(err)
        }
        res.json({ access_token, refresh_token, status: 200, data });
    }

}

_4ec‍.d(register_controller);